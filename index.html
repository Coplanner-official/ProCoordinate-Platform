<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProCoordinate - Construction Management Platform</title>
    <meta name="description" content="Professional construction project management platform. Manage drawings, track changes, coordinate teams, and streamline building projects.">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: white;
            text-decoration: none;
        }

        .nav-center {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .breadcrumb {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .breadcrumb span {
            color: white;
            font-weight: 600;
        }

        .user-info {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .company-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .main-content {
            flex: 1;
            padding: 30px 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h1 {
            color: white;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .page-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .project-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
            cursor: pointer;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .project-card h3 {
            color: white;
            font-size: 20px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .project-card p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .project-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .meta-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
        }

        .meta-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .meta-value {
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .project-stats {
            display: flex;
            gap: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-number {
            color: #60a5fa;
            font-size: 24px;
            font-weight: 700;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-top: 4px;
        }

        .new-project-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            transition: all 0.3s;
        }

        .new-project-card:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.1);
        }

        .new-project-card .icon {
            font-size: 48px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 16px;
        }

        .new-project-card p {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Project Detail View */
        .project-detail {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .project-title-section h2 {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .project-title-section p {
            color: rgba(255, 255, 255, 0.8);
        }

        .project-actions {
            display: flex;
            gap: 12px;
        }

        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border-color: rgba(255, 255, 255, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Drawings Section */
        .drawings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .drawing-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .drawing-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .drawing-preview {
            background: rgba(255, 255, 255, 0.2);
            height: 150px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 48px;
        }

        .drawing-info h4 {
            color: white;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .drawing-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .upload-zone {
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-zone:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.1);
        }

        .upload-zone .icon {
            font-size: 48px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 16px;
        }

        .upload-zone p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }

        .upload-zone small {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
        }

        /* Messages & Comments */
        .message-list {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .message-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-author {
            color: white;
            font-weight: 600;
        }

        .message-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
        }

        .message-text {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
        }

        .message-input-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
        }

        .message-input-area textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px;
            border-radius: 6px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .message-input-area textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Variations & Changes */
        .variation-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .variation-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #60a5fa;
        }

        .variation-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .variation-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .variation-id {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
        }

        .variation-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fbbf24;
            color: #78350f;
        }

        .status-approved {
            background: #34d399;
            color: #064e3b;
        }

        .status-rejected {
            background: #f87171;
            color: #7f1d1d;
        }

        .variation-details {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .variation-footer {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* History Timeline */
        .history-timeline {
            position: relative;
            padding-left: 40px;
        }

        .history-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.2);
        }

        .history-item {
            position: relative;
            margin-bottom: 24px;
        }

        .history-item::before {
            content: '';
            position: absolute;
            left: -29px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #60a5fa;
            border: 3px solid rgba(30, 58, 138, 0.5);
        }

        .history-content {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
        }

        .history-header {
            color: white;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .history-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .history-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
            color: #1e40af;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Auth */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 16px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .auth-form h2 {
            text-align: center;
            margin-bottom: 32px;
            color: #1e40af;
            font-size: 28px;
            font-weight: 700;
        }

        .auth-toggle {
            text-align: center;
            color: #6b7280;
            margin-top: 24px;
        }

        .auth-toggle a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: white;
            margin-bottom: 8px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .projects-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .project-actions {
                flex-direction: column;
            }

            .tab-nav {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Auth View -->
    <div id="authView" class="auth-container">
        <div class="auth-form">
            <h2 id="authTitle">Welcome to ProCoordinate</h2>
            <form id="authForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="authEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="authPassword" required placeholder="Your password">
                </div>
                <div class="form-group hidden" id="nameGroup">
                    <label>Full Name</label>
                    <input type="text" id="authName" placeholder="Your full name">
                </div>
                <div class="form-group hidden" id="companyGroup">
                    <label>Company Name</label>
                    <input type="text" id="authCompany" placeholder="Your company">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
            </form>
            <div class="auth-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <a href="#" onclick="toggleAuth(event)">Sign up</a>
            </div>
        </div>
    </div>

    <!-- App View -->
    <div id="appView" class="hidden">
        <nav class="navbar">
            <div class="nav-container">
                <a href="#" class="logo" onclick="showProjects(event)">ProCoordinate</a>
                <div class="nav-center">
                    <div class="breadcrumb" id="breadcrumb"></div>
                </div>
                <div class="user-info">
                    <span class="company-badge" id="companyName"></span>
                    <span id="userName"></span>
                    <button onclick="logout()" class="logout-btn">Logout</button>
                </div>
            </div>
        </nav>

        <main class="main-content">
            <!-- Projects List View -->
            <div id="projectsView">
                <div class="page-header">
                    <h1>Your Construction Projects</h1>
                    <p>Manage all your building projects in one place</p>
                </div>
                <div class="projects-grid" id="projectsGrid"></div>
            </div>

            <!-- Project Detail View -->
            <div id="projectDetailView" class="hidden">
                <div class="project-detail">
                    <div class="project-header">
                        <div class="project-title-section">
                            <h2 id="currentProjectName"></h2>
                            <p id="currentProjectDescription"></p>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-secondary btn-small" onclick="editCurrentProject()">Edit Project</button>
                            <button class="btn btn-secondary btn-small" onclick="showProjects(event)">‚Üê Back</button>
                        </div>
                    </div>

                    <div class="tab-nav">
                        <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
                        <button class="tab-btn" onclick="switchTab('drawings')">Drawings</button>
                        <button class="tab-btn" onclick="switchTab('messages')">Messages</button>
                        <button class="tab-btn" onclick="switchTab('variations')">Variations</button>
                        <button class="tab-btn" onclick="switchTab('changes')">Change Requests</button>
                        <button class="tab-btn" onclick="switchTab('history')">History</button>
                    </div>

                    <div id="tabOverview" class="tab-content active">
                        <div class="project-meta" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
                            <div class="meta-item">
                                <div class="meta-label">Start Date</div>
                                <div class="meta-value" id="projectStartDate">-</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">End Date</div>
                                <div class="meta-value" id="projectEndDate">-</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Location</div>
                                <div class="meta-value" id="projectLocation">-</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Budget</div>
                                <div class="meta-value" id="projectBudget">-</div>
                            </div>
                        </div>
                        <div class="project-stats">
                            <div class="stat-item">
                                <div class="stat-number" id="drawingsCount">0</div>
                                <div class="stat-label">Drawings</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="messagesCount">0</div>
                                <div class="stat-label">Messages</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="variationsCount">0</div>
                                <div class="stat-label">Variations</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="changesCount">0</div>
                                <div class="stat-label">Changes</div>
                            </div>
                        </div>
                    </div>

                    <div id="tabDrawings" class="tab-content">
                        <div class="upload-zone" onclick="document.getElementById('drawingUpload').click()">
                            <div class="icon">üìÑ</div>
                            <p><strong>Click to upload drawings</strong></p>
                            <small>Supported formats: PDF, PNG, JPG, DWG</small>
                        </div>
                        <input type="file" id="drawingUpload" class="hidden" multiple accept=".pdf,.png,.jpg,.jpeg,.dwg" onchange="handleDrawingUpload(event)">
                        <div class="drawings-grid" id="drawingsGrid"></div>
                    </div>

                    <div id="tabMessages" class="tab-content">
                        <div class="message-list" id="messagesList"></div>
                        <div class="message-input-area">
                            <textarea id="messageInput" placeholder="Type your message..."></textarea>
                            <button class="btn btn-primary" style="margin-top: 12px;" onclick="sendMessage()">Send Message</button>
                        </div>
                    </div>

                    <div id="tabVariations" class="tab-content">
                        <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openVariationModal()">+ New Variation</button>
                        <div class="variation-list" id="variationsList"></div>
                    </div>

                    <div id="tabChanges" class="tab-content">
                        <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openChangeModal()">+ New Change Request</button>
                        <div class="variation-list" id="changesList"></div>
                    </div>

                    <div id="tabHistory" class="tab-content">
                        <div class="history-timeline" id="historyTimeline"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <h2 id="projectModalTitle">Create New Project</h2>
            <form id="projectForm">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" id="projectName" required placeholder="e.g. Downtown Office Building">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="projectDescription" placeholder="Brief description of the project"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="projectStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>End Date *</label>
                        <input type="date" id="projectEndDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="projectLocationInput" placeholder="e.g. London, UK">
                    </div>
                    <div class="form-group">
                        <label>Budget (¬£)</label>
                        <input type="number" id="projectBudgetInput" placeholder="500000">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Variation Modal -->
    <div class="modal" id="variationModal">
        <div class="modal-content">
            <h2>New Variation</h2>
            <form id="variationForm">
                <div class="form-group">
                    <label>Variation Title *</label>
                    <input type="text" id="variationTitle" required placeholder="Brief title of variation">
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="variationDescription" required placeholder="Detailed description of the variation"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cost Impact (¬£)</label>
                        <input type="number" id="variationCost" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="variationStatus">
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('variationModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Variation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Request Modal -->
    <div class="modal" id="changeModal">
        <div class="modal-content">
            <h2>New Change Request</h2>
            <form id="changeForm">
                <div class="form-group">
                    <label>Change Title *</label>
                    <input type="text" id="changeTitle" required placeholder="Brief title of change request">
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="changeDescription" required placeholder="Detailed description of the requested change"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="changePriority">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="changeStatus">
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('changeModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Change Request</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global State
        let currentUser = null;
        let currentProject = null;
        let isSignup = false;
        let editingProjectId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', checkAuth);

        function checkAuth() {
            const userData = localStorage.getItem('pc_user');
            if (userData) {
                currentUser = JSON.parse(userData);
                showApp();
            } else {
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('authView').classList.remove('hidden');
            document.getElementById('appView').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('authView').classList.add('hidden');
            document.getElementById('appView').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('companyName').textContent = currentUser.company;
            loadProjects();
        }

        // Authentication
        document.getElementById('authForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const name = document.getElementById('authName').value;
            const company = document.getElementById('authCompany').value;

            if (isSignup) {
                if (!name || !company) {
                    alert('Please fill in all fields');
                    return;
                }
                const users = JSON.parse(localStorage.getItem('pc_users') || '[]');
                if (users.find(u => u.email === email)) {
                    alert('Email already registered');
                    return;
                }
                const newUser = { email, password, name, company, created: new Date().toISOString() };
                users.push(newUser);
                localStorage.setItem('pc_users', JSON.stringify(users));
                currentUser = { email, name, company };
                localStorage.setItem('pc_user', JSON.stringify(currentUser));
                addHistory('system', 'Account created', `New account created for ${company}`);
                showApp();
            } else {
                const users = JSON.parse(localStorage.getItem('pc_users') || '[]');
                const user = users.find(u => u.email === email && u.password === password);
                if (user) {
                    currentUser = { email: user.email, name: user.name, company: user.company };
                    localStorage.setItem('pc_user', JSON.stringify(currentUser));
                    showApp();
                } else {
                    alert('Invalid credentials');
                }
            }
        });

        function toggleAuth(e) {
            e.preventDefault();
            isSignup = !isSignup;
            document.getElementById('authTitle').textContent = isSignup ? 'Create Account' : 'Welcome Back';
            document.querySelector('#authForm .btn-primary').textContent = isSignup ? 'Sign Up' : 'Sign In';
            document.getElementById('authToggleText').textContent = isSignup ? 'Already have an account?' : "Don't have an account?";
            document.querySelector('.auth-toggle a').textContent = isSignup ? 'Sign in' : 'Sign up';
            document.getElementById('nameGroup').classList.toggle('hidden');
            document.getElementById('companyGroup').classList.toggle('hidden');
        }

        function logout() {
            localStorage.removeItem('pc_user');
            currentUser = null;
            currentProject = null;
            showAuth();
        }

        // Projects Management
        function getProjects() {
            const allProjects = JSON.parse(localStorage.getItem('pc_projects') || '[]');
            return allProjects.filter(p => p.userEmail === currentUser.email);
        }

        function saveProject(project) {
            const allProjects = JSON.parse(localStorage.getItem('pc_projects') || '[]');
            allProjects.push(project);
            localStorage.setItem('pc_projects', JSON.stringify(allProjects));
        }

        function updateProject(project) {
            const allProjects = JSON.parse(localStorage.getItem('pc_projects') || '[]');
            const index = allProjects.findIndex(p => p.id === project.id);
            if (index !== -1) {
                allProjects[index] = project;
                localStorage.setItem('pc_projects', JSON.stringify(allProjects));
            }
        }

        function deleteProject(projectId) {
            const allProjects = JSON.parse(localStorage.getItem('pc_projects') || '[]');
            const filtered = allProjects.filter(p => p.id !== projectId);
            localStorage.setItem('pc_projects', JSON.stringify(filtered));
        }

        function loadProjects() {
            const projects = getProjects();
            const grid = document.getElementById('projectsGrid');
            document.getElementById('breadcrumb').innerHTML = '<span>Projects</span>';
            
            grid.innerHTML = projects.map(p => `
                <div class="project-card" onclick="openProject('${p.id}')">
                    <h3>${p.name}</h3>
                    <p>${p.description || 'No description'}</p>
                    <div class="project-meta">
                        <div class="meta-item">
                            <div class="meta-label">Start</div>
                            <div class="meta-value">${formatDate(p.startDate)}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">End</div>
                            <div class="meta-value">${formatDate(p.endDate)}</div>
                        </div>
                    </div>
                    <div class="project-stats">
                        <div class="stat-item">
                            <div class="stat-number">${(p.drawings || []).length}</div>
                            <div class="stat-label">Drawings</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${(p.messages || []).length}</div>
                            <div class="stat-label">Messages</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${(p.variations || []).length}</div>
                            <div class="stat-label">Variations</div>
                        </div>
                    </div>
                </div>
            `).join('') + `
                <div class="project-card new-project-card" onclick="openProjectModal()">
                    <div class="icon">+</div>
                    <p>Create New Project</p>
                </div>
            `;

            document.getElementById('projectsView').classList.remove('hidden');
            document.getElementById('projectDetailView').classList.add('hidden');
        }

        function showProjects(e) {
            if (e) e.preventDefault();
            currentProject = null;
            loadProjects();
        }

        function openProject(projectId) {
            const projects = getProjects();
            currentProject = projects.find(p => p.id === projectId);
            if (!currentProject) return;

            document.getElementById('breadcrumb').innerHTML = `Projects > <span>${currentProject.name}</span>`;
            document.getElementById('currentProjectName').textContent = currentProject.name;
            document.getElementById('currentProjectDescription').textContent = currentProject.description || 'No description';
            document.getElementById('projectStartDate').textContent = formatDate(currentProject.startDate);
            document.getElementById('projectEndDate').textContent = formatDate(currentProject.endDate);
            document.getElementById('projectLocation').textContent = currentProject.location || 'Not specified';
            document.getElementById('projectBudget').textContent = '¬£' + (currentProject.budget || 0).toLocaleString();

            document.getElementById('projectsView').classList.add('hidden');
            document.getElementById('projectDetailView').classList.remove('hidden');

            switchTab('overview');
            updateProjectStats();
        }

        function updateProjectStats() {
            if (!currentProject) return;
            document.getElementById('drawingsCount').textContent = (currentProject.drawings || []).length;
            document.getElementById('messagesCount').textContent = (currentProject.messages || []).length;
            document.getElementById('variationsCount').textContent = (currentProject.variations || []).length;
            document.getElementById('changesCount').textContent = (currentProject.changes || []).length;
        }

        function openProjectModal() {
            editingProjectId = null;
            document.getElementById('projectModalTitle').textContent = 'Create New Project';
            document.getElementById('projectForm').reset();
            document.getElementById('projectModal').classList.add('active');
        }

        function editCurrentProject() {
            if (!currentProject) return;
            editingProjectId = currentProject.id;
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('projectName').value = currentProject.name;
            document.getElementById('projectDescription').value = currentProject.description || '';
            document.getElementById('projectStartDate').value = currentProject.startDate;
            document.getElementById('projectEndDate').value = currentProject.endDate;
            document.getElementById('projectLocationInput').value = currentProject.location || '';
            document.getElementById('projectBudgetInput').value = currentProject.budget || '';
            document.getElementById('projectModal').classList.add('active');
        }

        document.getElementById('projectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const projectData = {
                id: editingProjectId || 'proj_' + Date.now(),
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                startDate: document.getElementById('projectStartDate').value,
                endDate: document.getElementById('projectEndDate').value,
                location: document.getElementById('projectLocationInput').value,
                budget: parseInt(document.getElementById('projectBudgetInput').value) || 0,
                userEmail: currentUser.email,
                created: editingProjectId ? currentProject.created : new Date().toISOString(),
                modified: new Date().toISOString(),
                drawings: editingProjectId ? currentProject.drawings : [],
                messages: editingProjectId ? currentProject.messages : [],
                variations: editingProjectId ? currentProject.variations : [],
                changes: editingProjectId ? currentProject.changes : [],
                history: editingProjectId ? currentProject.history : []
            };

            if (editingProjectId) {
                updateProject(projectData);
                addHistory(currentProject.id, 'Project Updated', `Project details modified by ${currentUser.name}`);
                currentProject = projectData;
                openProject(projectData.id);
            } else {
                saveProject(projectData);
                addHistory(projectData.id, 'Project Created', `New project created by ${currentUser.name}`);
                loadProjects();
            }
            closeModal('projectModal');
        });

        // Tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');

            if (tabName === 'drawings') loadDrawings();
            if (tabName === 'messages') loadMessages();
            if (tabName === 'variations') loadVariations();
            if (tabName === 'changes') loadChanges();
            if (tabName === 'history') loadHistory();
        }

        // Drawings
        function loadDrawings() {
            const grid = document.getElementById('drawingsGrid');
            const drawings = currentProject.drawings || [];
            
            if (drawings.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="icon">üìÑ</div><h3>No drawings yet</h3><p>Upload your first drawing to get started</p></div>';
            } else {
                grid.innerHTML = drawings.map(d => `
                    <div class="drawing-card">
                        <div class="drawing-preview">üìÑ</div>
                        <div class="drawing-info">
                            <h4>${d.name}</h4>
                            <div class="drawing-meta">
                                <span>v${d.version}</span>
                                <span>${formatDate(d.uploaded)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function handleDrawingUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            currentProject.drawings = currentProject.drawings || [];
            
            Array.from(files).forEach(file => {
                const drawing = {
                    id: 'drw_' + Date.now() + Math.random(),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploaded: new Date().toISOString(),
                    version: 1,
                    uploadedBy: currentUser.name
                };
                currentProject.drawings.push(drawing);
                addHistory(currentProject.id, 'Drawing Uploaded', `${file.name} uploaded by ${currentUser.name}`);
            });

            updateProject(currentProject);
            loadDrawings();
            updateProjectStats();
        }

        // Messages
        function loadMessages() {
            const list = document.getElementById('messagesList');
            const messages = currentProject.messages || [];
            
            if (messages.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="icon">üí¨</div><h3>No messages yet</h3><p>Start the conversation</p></div>';
            } else {
                list.innerHTML = messages.map(m => `
                    <div class="message-item">
                        <div class="message-header">
                            <span class="message-author">${m.author}</span>
                            <span class="message-time">${formatDateTime(m.timestamp)}</span>
                        </div>
                        <div class="message-text">${m.text}</div>
                    </div>
                `).join('');
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;

            currentProject.messages = currentProject.messages || [];
            currentProject.messages.push({
                id: 'msg_' + Date.now(),
                author: currentUser.name,
                text: text,
                timestamp: new Date().toISOString()
            });

            updateProject(currentProject);
            addHistory(currentProject.id, 'Message Posted', `${currentUser.name} posted a message`);
            input.value = '';
            loadMessages();
            updateProjectStats();
        }

        // Variations
        function loadVariations() {
            const list = document.getElementById('variationsList');
            const variations = currentProject.variations || [];
            
            if (variations.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><h3>No variations yet</h3><p>Create your first variation</p></div>';
            } else {
                list.innerHTML = variations.map(v => `
                    <div class="variation-item">
                        <div class="variation-header">
                            <div>
                                <div class="variation-title">${v.title}</div>
                                <div class="variation-id">VAR-${v.id.slice(-6)}</div>
                            </div>
                            <span class="variation-status status-${v.status}">${v.status.toUpperCase()}</span>
                        </div>
                        <div class="variation-details">${v.description}</div>
                        <div class="variation-footer">
                            <span>Cost: ¬£${v.cost.toLocaleString()}</span>
                            <span>${formatDateTime(v.created)}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        function openVariationModal() {
            document.getElementById('variationForm').reset();
            document.getElementById('variationModal').classList.add('active');
        }

        document.getElementById('variationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            currentProject.variations = currentProject.variations || [];
            
            const variation = {
                id: 'var_' + Date.now(),
                title: document.getElementById('variationTitle').value,
                description: document.getElementById('variationDescription').value,
                cost: parseInt(document.getElementById('variationCost').value) || 0,
                status: document.getElementById('variationStatus').value,
                created: new Date().toISOString(),
                createdBy: currentUser.name
            };

            currentProject.variations.push(variation);
            updateProject(currentProject);
            addHistory(currentProject.id, 'Variation Added', `${variation.title} created by ${currentUser.name}`);
            closeModal('variationModal');
            loadVariations();
            updateProjectStats();
        });

        // Change Requests
        function loadChanges() {
            const list = document.getElementById('changesList');
            const changes = currentProject.changes || [];
            
            if (changes.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="icon">üîÑ</div><h3>No change requests yet</h3><p>Submit your first change request</p></div>';
            } else {
                list.innerHTML = changes.map(c => `
                    <div class="variation-item">
                        <div class="variation-header">
                            <div>
                                <div class="variation-title">${c.title}</div>
                                <div class="variation-id">CHG-${c.id.slice(-6)} | Priority: ${c.priority.toUpperCase()}</div>
                            </div>
                            <span class="variation-status status-${c.status}">${c.status.toUpperCase()}</span>
                        </div>
                        <div class="variation-details">${c.description}</div>
                        <div class="variation-footer">
                            <span>By: ${c.createdBy}</span>
                            <span>${formatDateTime(c.created)}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        function openChangeModal() {
            document.getElementById('changeForm').reset();
            document.getElementById('changeModal').classList.add('active');
        }

        document.getElementById('changeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            currentProject.changes = currentProject.changes || [];
            
            const change = {
                id: 'chg_' + Date.now(),
                title: document.getElementById('changeTitle').value,
                description: document.getElementById('changeDescription').value,
                priority: document.getElementById('changePriority').value,
                status: document.getElementById('changeStatus').value,
                created: new Date().toISOString(),
                createdBy: currentUser.name
            };

            currentProject.changes.push(change);
            updateProject(currentProject);
            addHistory(currentProject.id, 'Change Request', `${change.title} submitted by ${currentUser.name}`);
            closeModal('changeModal');
            loadChanges();
            updateProjectStats();
        });

        // History
        function addHistory(projectId, action, details) {
            if (projectId === 'system') return;
            
            const projects = getProjects();
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            project.history = project.history || [];
            project.history.unshift({
                id: 'hist_' + Date.now(),
                action: action,
                details: details,
                timestamp: new Date().toISOString(),
                user: currentUser.name
            });

            updateProject(project);
        }

        function loadHistory() {
            const timeline = document.getElementById('historyTimeline');
            const history = currentProject.history || [];
            
            if (history.length === 0) {
                timeline.innerHTML = '<div class="empty-state"><div class="icon">üìú</div><h3>No history yet</h3><p>Activity will appear here</p></div>';
            } else {
                timeline.innerHTML = history.map(h => `
                    <div class="history-item">
                        <div class="history-content">
                            <div class="history-header">${h.action}</div>
                            <div class="history-text">${h.details}</div>
                            <div class="history-time">${formatDateTime(h.timestamp)}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Utilities
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('en-GB', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
            }
        });
    </script>
</body>
</html>
